name: 'Run Infracost'
on:
  pull_request:
    types: [opened, synchronize, closed]
    branches:
            - staging
            - main
     
permissions:
    contents: read
    checks: write

jobs:
  check-terraform-changes:
    name: Check Terraform Changes
    runs-on: ubuntu-latest
    outputs:
      has_tf_changes: ${{ steps.check-tf.outputs.has_changes }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Get Changed Files
        uses: tj-actions/changed-files@v40
      - name: Check for Terraform Changes
        id: check-tf
        run: |
          changed_files="${{ steps.changed-files.outputs.all_changed_files }}"
          if echo "$changed_files" | grep -q '\.tf\|\.tfvars\|\.tfvars\.json'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  infracost-pull-request-checks:
    needs: check-terraform-changes
    name: Infracost Pull Request Checks
    if: |
      needs.check-terraform-changes.outputs.has_tf_changes == 'true' && 
      github.event_name == 'pull_request' && 
      (github.event.action == 'opened' || github.event.action == 'synchronize')
    runs-on: ubuntu-latest
    environment: ${{ github.base_ref == 'main' && 'production' || github.base_ref == 'staging' && 'staging' || 'staging' }}
    permissions:
      contents: read
      pull-requests: write # Required to post comments
    steps:
      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
      # Checkout the base branch of the pull request (e.g. main/master).
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: '${{ github.event.pull_request.base.ref }}'
      # Generate Infracost JSON file as the baseline.
      - name: Generate Infracost cost estimate baseline
        run: |
          infracost breakdown --path=. \
                              --format=json \
                              --out-file=/tmp/infracost-base.json
      # Checkout the current PR branch so we can create a diff.
      - name: Checkout PR branch
        uses: actions/checkout@v4
      # Generate an Infracost diff and save it to a JSON file.
      - name: Generate Infracost diff
        run: |
          infracost diff --path=. \
                          --format=json \
                          --compare-to=/tmp/infracost-base.json \
                          --out-file=/tmp/infracost.json
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest
                  
      - name: Evaluate OPA Policy
        run: |
          opa eval --input /tmp/infracost.json --data ./policies/cost.rego 'data.infracost.deny' > opa_result.json
          cat opa_result.json
          
      - name: Post Infracost comment
        run: |
            infracost comment github --path=/tmp/infracost.json \
                         --repo=$GITHUB_REPOSITORY \
                         --github-token=${{ github.token }} \
                         --pull-request=${{ github.event.pull_request.number }} \
                         --behavior=update \
                         --policy-path=policies/cost.rego


  auto-approve-no-tf-changes:
    needs: check-terraform-changes
    name: Auto Approve if no Terraform Changes
    if: needs.check-terraform-changes.outputs.has_tf_changes == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Create Success Status Check
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Infracost Check',
              head_sha: context.sha,
              status: 'completed',
              conclusion: 'success',
              output: {
                title: 'No Terraform Changes',
                summary: 'No Terraform files were modified in this PR - skipping Infracost check'
              }
            });
